<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Users Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="../assets/favicon-16x16.svg">
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="../assets/favicon-32x32.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/apple-touch-icon.svg">
    <link rel="stylesheet" href="../styles.css">
    <style>
        body {
            background: #f5f7fa;
        }
        .admin-header {
            background: linear-gradient(135deg, #1a3a5c 0%, #0A1A2F 100%);
            color: white;
            padding: 30px 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .admin-header .container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-header h1 {
            font-size: 32px;
            margin: 0;
        }
        .admin-nav {
            display: flex;
            gap: 15px;
        }
        .admin-nav a {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            text-decoration: none;
            transition: all 0.2s;
        }
        .admin-nav a:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .logout-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .admin-content {
            max-width: 1600px;
            margin: 40px auto;
            padding: 0 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .stat-card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-card .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #3b82f6;
        }
        .users-list {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        .users-list-header {
            padding: 20px 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .users-list-header h2 {
            margin: 0;
            font-size: 24px;
        }
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-dropdown, .sort-dropdown {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            background: white;
        }
        .user-card {
            padding: 25px;
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s;
        }
        .user-card:hover {
            background: #f8f9fa;
        }
        .user-card:last-child {
            border-bottom: none;
        }
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .user-info {
            flex: 1;
            min-width: 250px;
        }
        .user-name {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px;
        }
        .user-email {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        .user-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .tier-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .tier-badge.free {
            background-color: #00A676;
            color: white;
        }
        .tier-badge.pro {
            background-color: #f59e0b;
            color: white;
        }
        .tier-badge.premium {
            background-color: #3b82f6;
            color: white;
        }
        .tier-selector {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }
        .tier-selector:hover {
            border-color: #3b82f6;
        }
        .tier-selector:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .tier-selector.free {
            color: #00A676;
            border-color: #00A676;
        }
        .tier-selector.pro {
            color: #f59e0b;
            border-color: #f59e0b;
        }
        .tier-selector.premium {
            color: #3b82f6;
            border-color: #3b82f6;
        }
        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
        }
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-value-small {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }
        .progress-section {
            margin-top: 20px;
        }
        .progress-section h4 {
            font-size: 14px;
            color: var(--text-dark);
            margin-bottom: 12px;
            font-weight: 600;
        }
        .overall-progress {
            margin-bottom: 20px;
        }
        .progress-bar-container {
            background: #e5e7eb;
            border-radius: 8px;
            height: 28px;
            position: relative;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        .progress-bar {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s ease;
            position: absolute;
            left: 0;
            top: 0;
        }
        .progress-percentage {
            position: absolute;
            right: 10px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            z-index: 1;
        }
        .progress-bar.green {
            background: linear-gradient(90deg, #00A676 0%, #00d993 100%);
        }
        .progress-bar.yellow {
            background: linear-gradient(90deg, #d1d5db 0%, #9ca3af 100%);
        }
        .progress-bar.gray {
            background: #d1d5db;
        }
        .progress-label {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .path-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 8px;
        }
        .path-item {
            background: #f8f9fa;
            padding: 8px 10px;
            border-radius: 6px;
            border: 2px solid transparent;
            text-align: center;
        }
        .path-item.current {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .path-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 6px;
        }
        .path-progress {
            background: #e5e7eb;
            border-radius: 3px;
            height: 6px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        .path-progress .progress-bar {
            height: 100%;
            font-size: 0;
        }
        .path-stats {
            font-size: 10px;
            color: var(--text-secondary);
        }
        .progress-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .progress-details.expanded {
            max-height: 1000px;
        }
        .toggle-details {
            background: none;
            border: none;
            color: #3b82f6;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 0;
            margin-top: 10px;
            text-decoration: underline;
        }
        .toggle-details:hover {
            color: #2563eb;
        }
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-primary);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-btn:hover {
            background: #2563eb;
        }
        .error-message {
            padding: 12px;
            background: #fee2e2;
            color: #991b1b;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        .no-users {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Login Form (shown initially) -->
    <div id="loginContainer">
        <div class="login-form">
            <h2>Admin Login</h2>
            <div id="loginError" class="error-message"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password" placeholder="Enter admin password">
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard (hidden initially) -->
    <div id="dashboardContainer" style="display: none;">
        <!-- Header -->
        <header class="admin-header">
            <div class="container">
                <h1>Users Dashboard</h1>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <nav class="admin-nav">
                        <a href="/admin/users">Users</a>
                        <a href="/admin/feedback">Feedback</a>
                    </nav>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="admin-content">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Free Tier</h3>
                    <div class="stat-value" id="freeCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>Pro Tier</h3>
                    <div class="stat-value" id="proCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>Premium Tier</h3>
                    <div class="stat-value" id="premiumCount">0</div>
                </div>
            </div>

            <!-- Users List -->
            <div class="users-list">
                <div class="users-list-header">
                    <h2>All Users</h2>
                    <div class="filters">
                        <select class="filter-dropdown" id="filterTier" onchange="applyFilters()">
                            <option value="all">All Tiers</option>
                            <option value="free">Free</option>
                            <option value="pro">Pro</option>
                            <option value="premium">Premium</option>
                        </select>
                        <select class="filter-dropdown" id="filterCompletion" onchange="applyFilters()">
                            <option value="all">All Completion</option>
                            <option value="0">0% Complete</option>
                            <option value="1-25">1-25% Complete</option>
                            <option value="26-50">26-50% Complete</option>
                            <option value="51-75">51-75% Complete</option>
                            <option value="76-99">76-99% Complete</option>
                            <option value="100">100% Complete</option>
                        </select>
                        <select class="sort-dropdown" id="sortBy" onchange="applyFilters()">
                            <option value="signup">Sort by Signup Date</option>
                            <option value="activity">Sort by Last Activity</option>
                            <option value="progress">Sort by Progress</option>
                            <option value="name">Sort by Name</option>
                        </select>
                    </div>
                </div>
                <div id="usersContainer">
                    <div class="loading">Loading users...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="../config.js"></script>
    <script>
        let adminCredentials = null;
        let allUsers = [];

        // Handle login
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const password = document.getElementById('password').value;

            // Store credentials for API calls (username is always "admin")
            adminCredentials = btoa(`admin:${password}`);

            try {
                console.log('üîê Attempting admin login to:', `${API_URL}/admin/users`);
                const response = await fetch(`${API_URL}/admin/users`, {
                    headers: {
                        'Authorization': `Basic ${adminCredentials}`
                    }
                });

                console.log('üì• Login response status:', response.status);

                if (response.ok) {
                    console.log('‚úÖ Login successful');
                    // Store in session
                    sessionStorage.setItem('adminAuth', adminCredentials);
                    // Hide login, show dashboard
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('dashboardContainer').style.display = 'block';
                    // Load users
                    loadUsers();
                } else {
                    console.error('‚ùå Login failed with status:', response.status);
                    loginError.textContent = 'Invalid password';
                    loginError.classList.add('show');
                    adminCredentials = null;
                }
            } catch (error) {
                console.error('‚ùå Login error:', error);
                console.error('Error details:', error.message);
                loginError.textContent = `Network error: ${error.message}. Please try again.`;
                loginError.classList.add('show');
                adminCredentials = null;
            }
        });

        // Check if already logged in
        window.addEventListener('load', () => {
            const savedAuth = sessionStorage.getItem('adminAuth');
            if (savedAuth) {
                adminCredentials = savedAuth;
                verifyAndLoadDashboard();
            }
        });

        async function verifyAndLoadDashboard() {
            try {
                const response = await fetch(`${API_URL}/admin/users`, {
                    headers: {
                        'Authorization': `Basic ${adminCredentials}`
                    }
                });

                if (response.ok) {
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('dashboardContainer').style.display = 'block';
                    loadUsers();
                } else {
                    sessionStorage.removeItem('adminAuth');
                    adminCredentials = null;
                }
            } catch (error) {
                console.error('Verification error:', error);
                sessionStorage.removeItem('adminAuth');
                adminCredentials = null;
            }
        }

        // Load users from API
        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/admin/users`, {
                    headers: {
                        'Authorization': `Basic ${adminCredentials}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    allUsers = data.users;
                    updateStats(data.users);
                    applyFilters();
                } else {
                    throw new Error('Failed to load users');
                }
            } catch (error) {
                console.error('Load users error:', error);
                document.getElementById('usersContainer').innerHTML = `
                    <div class="no-users">
                        <h3>Error loading users</h3>
                        <p>Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        // Update statistics
        function updateStats(users) {
            document.getElementById('freeCount').textContent = users.filter(u => u.membership_tier === 'free').length;
            document.getElementById('proCount').textContent = users.filter(u => u.membership_tier === 'pro').length;
            document.getElementById('premiumCount').textContent = users.filter(u => u.membership_tier === 'premium').length;
        }

        // Apply filters and sorting
        function applyFilters() {
            const tierFilter = document.getElementById('filterTier').value;
            const completionFilter = document.getElementById('filterCompletion').value;
            const sortBy = document.getElementById('sortBy').value;

            let filtered = [...allUsers];

            // Filter by tier
            if (tierFilter !== 'all') {
                filtered = filtered.filter(u => u.membership_tier === tierFilter);
            }

            // Filter by completion
            if (completionFilter !== 'all') {
                if (completionFilter === '0') {
                    filtered = filtered.filter(u => u.progress.overallPercentage === 0);
                } else if (completionFilter === '100') {
                    filtered = filtered.filter(u => u.progress.overallPercentage === 100);
                } else {
                    const [min, max] = completionFilter.split('-').map(Number);
                    filtered = filtered.filter(u => {
                        const pct = u.progress.overallPercentage;
                        return pct >= min && pct <= max;
                    });
                }
            }

            // Sort
            if (sortBy === 'activity') {
                filtered.sort((a, b) => {
                    const dateA = a.progress.lastActivity ? new Date(a.progress.lastActivity) : new Date(0);
                    const dateB = b.progress.lastActivity ? new Date(b.progress.lastActivity) : new Date(0);
                    return dateB - dateA;
                });
            } else if (sortBy === 'progress') {
                filtered.sort((a, b) => b.progress.overallPercentage - a.progress.overallPercentage);
            } else if (sortBy === 'name') {
                filtered.sort((a, b) => a.name.localeCompare(b.name));
            } else {
                // Sort by signup date (default)
                filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }

            displayUsers(filtered);
        }

        // Get progress bar color
        function getProgressColor(percentage) {
            if (percentage === 0) return 'gray';
            if (percentage === 100) return 'green';
            return 'yellow';
        }

        // Display users
        function displayUsers(users) {
            const container = document.getElementById('usersContainer');

            if (users.length === 0) {
                container.innerHTML = `
                    <div class="no-users">
                        <h3>No users found</h3>
                        <p>Try adjusting your filters</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = users.map(user => {
                const signupDate = new Date(user.created_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const lastActivity = user.progress.lastActivity
                    ? new Date(user.progress.lastActivity).toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                    : 'No activity yet';

                const overallColor = getProgressColor(user.progress.overallPercentage);

                return `
                    <div class="user-card">
                        <div class="user-header">
                            <div class="user-info">
                                <div class="user-name">${escapeHtml(user.name)}</div>
                                <div class="user-email">${escapeHtml(user.email)}</div>
                                <div class="user-meta">
                                    <select class="tier-selector ${user.membership_tier}" onchange="changeTier(${user.id}, this.value)" data-user-id="${user.id}">
                                        <option value="free" ${user.membership_tier === 'free' ? 'selected' : ''}>Free</option>
                                        <option value="pro" ${user.membership_tier === 'pro' ? 'selected' : ''}>Pro</option>
                                        <option value="premium" ${user.membership_tier === 'premium' ? 'selected' : ''}>Premium</option>
                                    </select>
                                    <span style="color: var(--text-secondary); font-size: 13px;">ID: #${user.id}</span>
                                    <span style="color: var(--text-secondary); font-size: 13px;">Joined: ${signupDate}</span>
                                </div>
                            </div>
                        </div>

                        <div class="progress-section">
                            <div class="overall-progress">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 14px; font-weight: 600; color: var(--text-dark);">Overall Progress</span>
                                    <span style="font-size: 16px; font-weight: 700; color: var(--text-dark);">${user.progress.overallPercentage}%</span>
                                </div>
                                <div style="background: #e5e7eb; border-radius: 10px; height: 20px; overflow: hidden; position: relative;">
                                    <div style="background: ${user.progress.overallPercentage === 100 ? 'linear-gradient(90deg, #00A676, #10b981)' : user.progress.overallPercentage > 0 ? 'linear-gradient(90deg, #3b82f6, #60a5fa)' : '#d1d5db'}; height: 100%; width: ${user.progress.overallPercentage}%; transition: width 0.3s ease;"></div>
                                </div>
                                <div class="progress-label" style="margin-top: 8px;">${user.progress.completedLessons} of ${user.progress.totalLessons} lessons completed</div>
                            </div>

                            <button class="toggle-details" onclick="togglePathDetails(${user.id})">
                                <span id="toggle-text-${user.id}">Show path details</span>
                            </button>

                            <div class="progress-details" id="path-details-${user.id}">
                                <div class="path-grid">
                                    ${Object.entries(user.progress.pathProgress).map(([path, data]) => {
                                        const color = getProgressColor(data.percentage);
                                        const isCurrent = path === user.progress.currentPath;
                                        return `
                                            <div class="path-item ${isCurrent ? 'current' : ''}" title="${path.replace('path', 'Path ')}: ${data.completed}/${data.total} lessons (${data.percentage}%)">
                                                <div class="path-name">${path.replace('path', 'P')}${isCurrent ? ' ‚≠ê' : ''}</div>
                                                <div style="background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden; margin: 6px 0;">
                                                    <div style="background: ${data.percentage === 100 ? '#00A676' : data.percentage > 0 ? '#3b82f6' : '#d1d5db'}; height: 100%; width: ${data.percentage}%; transition: width 0.3s ease;"></div>
                                                </div>
                                                <div class="path-stats" style="font-size: 11px; font-weight: 600;">${data.percentage}%</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle path details
        function togglePathDetails(userId) {
            const detailsDiv = document.getElementById(`path-details-${userId}`);
            const toggleText = document.getElementById(`toggle-text-${userId}`);

            if (detailsDiv.classList.contains('expanded')) {
                detailsDiv.classList.remove('expanded');
                toggleText.textContent = 'Show path details';
            } else {
                detailsDiv.classList.add('expanded');
                toggleText.textContent = 'Hide path details';
            }
        }

        // Logout
        function logout() {
            sessionStorage.removeItem('adminAuth');
            adminCredentials = null;
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('dashboardContainer').style.display = 'none';
            loginForm.reset();
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Change user subscription tier
        async function changeTier(userId, newTier) {
            const select = document.querySelector(`select[data-user-id="${userId}"]`);
            const originalTier = allUsers.find(u => u.id === userId)?.membership_tier;

            try {
                console.log(`Updating user ${userId} tier to ${newTier}`);

                const response = await fetch(`${API_URL}/admin/users/${userId}/tier`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Basic ${adminCredentials}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tier: newTier })
                });

                if (response.ok) {
                    console.log('‚úÖ Tier updated successfully');

                    // Update the local data
                    const userIndex = allUsers.findIndex(u => u.id === userId);
                    if (userIndex !== -1) {
                        allUsers[userIndex].membership_tier = newTier;
                    }

                    // Update the select element styling
                    select.className = `tier-selector ${newTier}`;

                    // Update stats
                    updateStats(allUsers);

                    // Show success message
                    alert(`Subscription tier updated to ${newTier.toUpperCase()} successfully!`);
                } else {
                    throw new Error('Failed to update tier');
                }
            } catch (error) {
                console.error('Error updating tier:', error);
                alert('Error updating subscription tier. Please try again.');

                // Revert the select to original value
                if (originalTier) {
                    select.value = originalTier;
                    select.className = `tier-selector ${originalTier}`;
                }
            }
        }
    </script>
</body>
</html>

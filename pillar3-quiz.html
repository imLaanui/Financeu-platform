<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pillar 3 Final Quiz - FinanceU</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="assets/favicon-16x16.svg">
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="assets/favicon-32x32.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.svg">
    <link rel="stylesheet" href="styles.css">
    <style>
        .quiz-container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
        .quiz-header { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 3px solid var(--primary-color); }
        .quiz-header h1 { font-size: 48px; color: var(--text-primary); margin-bottom: 10px; }
        .quiz-progress { background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 30px; text-align: center; font-weight: 600; color: var(--text-secondary); }
        .question-card { background: white; padding: 40px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); border: 3px solid #e5e7eb; }
        .question-number { color: var(--primary-color); font-weight: 700; margin-bottom: 10px; font-size: 14px; }
        .question-text { font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 20px; line-height: 1.6; }
        .answer-options { display: flex; flex-direction: column; gap: 12px; }
        .answer-option { padding: 15px 20px; border: 3px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; }
        .answer-option:hover { border-color: var(--primary-color); background: #f9fafb; }
        .answer-option input[type="radio"] { width: 20px; height: 20px; cursor: pointer; }
        .answer-option label { cursor: pointer; flex: 1; color: var(--text-secondary); }
        .btn-submit-quiz { display: block; width: 100%; max-width: 400px; margin: 30px auto; padding: 18px; background: var(--primary-color); color: white; text-align: center; border-radius: 8px; font-size: 18px; font-weight: 600; transition: background 0.2s; border: none; cursor: pointer; }
        .btn-submit-quiz:hover { background: #050f1a; }
        .btn-submit-quiz:disabled { background: #d1d5db; cursor: not-allowed; }
        .result-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .result-content { background: white; padding: 40px; border-radius: 16px; max-width: 500px; width: 90%; text-align: center; position: relative; }
        .result-content.pass { border-top: 8px solid #00A676; animation: slideInDown 0.5s ease-out; }
        .result-content.fail { border-top: 8px solid #ef4444; }
        .result-score { font-size: 72px; font-weight: 700; margin: 20px 0; }
        .result-score.pass { color: #00A676; animation: scaleIn 0.6s ease-out; }
        .result-score.fail { color: #ef4444; }
        .result-message { font-size: 20px; font-weight: 600; margin-bottom: 10px; }
        .result-details { color: var(--text-secondary); margin-bottom: 30px; }
        .btn-result { padding: 15px 30px; border-radius: 8px; font-weight: 600; text-decoration: none; display: inline-block; margin: 0 10px; }
        .btn-retry { background: #ef4444; color: white; }
        .btn-continue { background: var(--primary-color); color: white; }
        .back-link { display: inline-block; margin-bottom: 20px; color: var(--primary-color); text-decoration: none; font-weight: 600; }
        .back-link:hover { text-decoration: underline; }

        @keyframes slideInDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes scaleIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .confetti { position: absolute; width: 10px; height: 10px; background: #00A676; top: -10px; animation: confettiFall 3s linear; }

        @keyframes confettiFall {
            to { transform: translateY(600px) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <div class="logo"><a href="/" style="color: inherit; text-decoration: none;">Finance<span class="logo-accent">U</span></a></div>
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href="dashboard">Dashboard</a></li>
                    <li id="authButtons" style="opacity: 0;">
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="quiz-container">
        <a href="/pillar3-lessons" class="back-link">← Back to Pillar 3 Lessons</a>

        <div class="quiz-header">
            <h1>Pillar 3 Final Quiz</h1>
            <p style="color: var(--text-secondary);">Test your knowledge of Credit & Debt Mastery</p>
            <p style="color: var(--text-secondary); margin-top: 10px;">16 questions • 100% to pass</p>
        </div>

        <div class="quiz-progress" id="progress">
            Question <span id="currentQ">0</span> of <span id="totalQ">16</span>
        </div>

        <form id="quizForm">
            <!-- Questions will be inserted here by JavaScript -->
        </form>

        <button type="button" class="btn-submit-quiz" id="submitBtn" onclick="submitQuiz()">Submit Quiz</button>
    </div>

    <div class="result-modal" id="resultModal">
        <div class="result-content" id="resultContent">
            <h2 class="result-message" id="resultMessage"></h2>
            <div class="result-score" id="resultScore"></div>
            <p class="result-details" id="resultDetails"></p>
            <div>
                <a href="/pillar3-quiz" class="btn-result btn-retry" id="retryBtn" style="display: none;">Retry Quiz</a>
                <a href="/pillar3-lessons" class="btn-result btn-continue">Back to Lessons</a>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>FinanceU</h4>
                    <p>Making financial literacy accessible for everyone.</p>
                </div>
                <div class="footer-section">
                    <h4>Company</h4>
                    <ul>
                        <li><a href="/about">About Us</a></li>
                        <li><a href="/careers">Careers</a></li>
                        <li><a href="/contact">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Support</h4>
                    <ul>
                        <li><a href="/help">Help Center</a></li>
                        <li><a href="/privacy">Privacy Policy</a></li>
                        <li><a href="/terms">Terms of Service</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 10px;">Disclaimer: FinanceU provides educational content only and does not offer financial, legal, or investment advice. Always consult with a qualified professional before making financial decisions.</p>
                <p>&copy; 2025 FinanceU. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="config.js"></script>
    <script src="animations.js"></script>
    <script>
        const questions = [
            // Lesson 1: Credit Scores
            { lesson: 1, question: "What percentage of your credit score is determined by payment history?", answers: ["15%", "25%", "35%", "45%"], correct: 2 },
            { lesson: 1, question: "Which credit score range is generally considered \"good\"?", answers: ["580-669", "670-739", "740-799", "800-850"], correct: 1 },

            // Lesson 2: Building Credit
            { lesson: 2, question: "What is a secured credit card?", answers: ["Card requiring security deposit that becomes your credit limit", "Card with extra security features", "Card only for people with good credit", "Card insured by government"], correct: 0 },
            { lesson: 2, question: "What is the main benefit of becoming an authorized user?", answers: ["You get your own credit score", "Primary cardholder's credit history can help build your credit", "You're not responsible for any debt", "You can't be removed from the account"], correct: 1 },

            // Lesson 3: First Credit Card
            { lesson: 3, question: "What is APR?", answers: ["Annual Payment Required", "Annual Percentage Rate - yearly interest on credit balances", "Automatic Payment Reminder", "Average Purchase Rate"], correct: 1 },
            { lesson: 3, question: "What is a grace period on a credit card?", answers: ["Extra time before card expires", "Time you have to pay balance without interest charges (typically 21-25 days)", "Period when you can't use your card", "Time to change your mind on a purchase"], correct: 1 },

            // Lesson 4: Best Practices
            { lesson: 4, question: "What is the recommended credit utilization ratio?", answers: ["Under 10%", "Under 30%", "Under 50%", "Under 80%"], correct: 1 },
            { lesson: 4, question: "What's the safest autopay setting for credit cards?", answers: ["Minimum payment only", "Fixed $100 monthly", "Full statement balance", "Current balance"], correct: 2 },

            // Lesson 5: Debt Traps
            { lesson: 5, question: "What is the typical APR range for payday loans?", answers: ["10-20%", "50-100%", "150-300%", "300-400%+"], correct: 3 },
            { lesson: 5, question: "What is a major risk of Buy Now, Pay Later services?", answers: ["They require excellent credit", "They have high upfront fees", "They make it easy to overextend and create multiple payment obligations", "They're illegal in most states"], correct: 2 },

            // Lesson 6: Student Loans
            { lesson: 6, question: "What's the main difference between subsidized and unsubsidized federal student loans?", answers: ["Subsidized loans have lower interest rates", "Government pays interest on subsidized loans while you're in school", "Subsidized loans don't need to be repaid", "Unsubsidized loans are private"], correct: 1 },
            { lesson: 6, question: "What is the typical grace period for federal student loans after graduation?", answers: ["3 months", "6 months", "12 months", "24 months"], correct: 1 },

            // Lesson 7: Good vs Bad Debt
            { lesson: 7, question: "Which of these is generally considered \"good debt\"?", answers: ["Credit card debt from vacation", "Mortgage on a home", "Personal loan for furniture", "Payday loan for emergency"], correct: 1 },
            { lesson: 7, question: "What is considered a healthy debt-to-income ratio?", answers: ["Under 20% is ideal, under 36% is acceptable", "Under 50%", "Under 75%", "Any amount is fine"], correct: 0 },

            // Lesson 8: Credit Monitoring
            { lesson: 8, question: "How often can you get a free credit report from each bureau?", answers: ["Once every 6 months", "Once per year", "Once every 2 years", "Only when you're denied credit"], correct: 1 },
            { lesson: 8, question: "What's the difference between a credit freeze and fraud alert?", answers: ["There is no difference", "A freeze blocks all new credit applications; a fraud alert requires creditors to verify your identity", "Fraud alerts are permanent, freezes are temporary", "Only fraud alerts cost money"], correct: 1 }
        ];

        // Shuffle both questions and answers
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Shuffle questions and their answers
        const shuffledQuestions = shuffleArray(questions).map(q => {
            const answerIndices = q.answers.map((answer, i) => ({ answer, originalIndex: i }));
            const shuffledAnswers = shuffleArray(answerIndices);
            return {
                ...q,
                answers: shuffledAnswers.map(a => a.answer),
                correct: shuffledAnswers.findIndex(a => a.originalIndex === q.correct)
            };
        });

        // Render questions
        function renderQuestions() {
            const form = document.getElementById('quizForm');
            shuffledQuestions.forEach((q, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.innerHTML = `
                    <div class="question-number">Question ${index + 1} of 16</div>
                    <div class="question-text">${q.question}</div>
                    <div class="answer-options">
                        ${q.answers.map((answer, i) => `
                            <div class="answer-option">
                                <input type="radio" id="q${index}_a${i}" name="q${index}" value="${i}" required>
                                <label for="q${index}_a${i}">${answer}</label>
                            </div>
                        `).join('')}
                    </div>
                `;
                form.appendChild(questionCard);
            });

            document.getElementById('totalQ').textContent = shuffledQuestions.length;
            updateProgress();
        }

        // Update progress
        function updateProgress() {
            const answered = document.querySelectorAll('input[type="radio"]:checked').length;
            document.getElementById('currentQ').textContent = answered;
        }

        // Add event listeners for progress tracking
        document.addEventListener('change', (e) => {
            if (e.target.type === 'radio') {
                updateProgress();
            }
        });

        // Create confetti effect
        function createConfetti() {
            const colors = ['#00A676', '#0A1F44', '#FFD700', '#FF69B4', '#4169E1'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.getElementById('resultContent').appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        // Submit quiz
        function submitQuiz() {
            const form = document.getElementById('quizForm');
            if (!form.checkValidity()) {
                alert('Please answer all questions before submitting.');
                return;
            }

            let correct = 0;
            shuffledQuestions.forEach((q, index) => {
                const selected = document.querySelector(`input[name="q${index}"]:checked`);
                if (selected && parseInt(selected.value) === q.correct) {
                    correct++;
                }
            });

            const percentage = Math.round((correct / shuffledQuestions.length) * 100);
            const passed = percentage === 100;

            // Show results
            const modal = document.getElementById('resultModal');
            const content = document.getElementById('resultContent');
            const message = document.getElementById('resultMessage');
            const score = document.getElementById('resultScore');
            const details = document.getElementById('resultDetails');
            const retryBtn = document.getElementById('retryBtn');

            if (passed) {
                content.className = 'result-content pass';
                message.textContent = 'Congratulations! You Passed!';
                score.className = 'result-score pass';
                score.textContent = `${percentage}%`;
                details.textContent = `Perfect score! You answered all ${shuffledQuestions.length} questions correctly.`;
                retryBtn.style.display = 'none';

                // Create confetti animation
                createConfetti();

                // Save completion with user-specific keys
                const userId = localStorage.getItem('userId');
                localStorage.setItem(`pillar3_quiz_completed_${userId}`, 'true');
                localStorage.setItem(`pillar3_quiz_score_${userId}`, percentage);
            } else {
                content.className = 'result-content fail';
                message.textContent = 'Not Quite There Yet';
                score.className = 'result-score fail';
                score.textContent = `${percentage}%`;
                details.textContent = `You answered ${correct} out of ${shuffledQuestions.length} questions correctly. You need 100% to pass. Review the lessons and try again!`;
                retryBtn.style.display = 'inline-block';
            }

            modal.style.display = 'flex';
        }

        // Auth nav function
        async function updateNav() {
            const authButtons = document.getElementById('authButtons');
            const cachedAuth = localStorage.getItem('authState');
            if (cachedAuth) {
                const authState = JSON.parse(cachedAuth);
                authButtons.innerHTML = authState.isLoggedIn
                    ? `<a href="#" onclick="logout(); return false;" class="btn-primary">Logout</a>`
                    : `<a href="login" class="btn-primary">Login</a>`;
                authButtons.style.opacity = '1';
            }
            try {
                const response = await fetch(`${API_URL}/auth/me`, { credentials: 'include' });
                if (response.ok) {
                    localStorage.setItem('authState', JSON.stringify({ isLoggedIn: true }));
                    authButtons.innerHTML = `<a href="#" onclick="logout(); return false;" class="btn-primary">Logout</a>`;
                } else {
                    localStorage.setItem('authState', JSON.stringify({ isLoggedIn: false }));
                    authButtons.innerHTML = `<a href="login" class="btn-primary">Login</a>`;
                }
                authButtons.style.opacity = '1';
            } catch (error) {
                console.log('Not logged in');
                localStorage.setItem('authState', JSON.stringify({ isLoggedIn: false }));
                authButtons.innerHTML = `<a href="login" class="btn-primary">Login</a>`;
                authButtons.style.opacity = '1';
            }
        }

        async function logout() {
            // Clear auth data only - keep user-specific progress data
            localStorage.removeItem('authState');
            localStorage.removeItem('token');
            localStorage.removeItem('userId');

            try {
                await fetch(`${API_URL}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/index.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/index.html';
            }
        }

        // Initialize
        renderQuestions();
        updateNav();
    </script>
</body>
</html>
